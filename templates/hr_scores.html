<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HR Scores</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .muted { color: #666; }
    .player-card {
      cursor: pointer;
      transition: transform .1s ease-in-out;
  /* Simpler fallback to avoid nested var() warnings */
  border: 2px solid var(--team-primary, #dee2e6);
    }
    .player-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,.08); }
  .score-pill { font-weight: 700; font-size: 1.0rem; }
    .score-pill.badge {
      padding: .5rem .65rem;
      background: var(--team-primary, #0d6efd) !important;
      color: var(--team-text, #ffffff) !important;
    }
  .player-img { width: 100%; height: 80px; object-fit: cover; background: #f5f5f5; }
  .media-row { min-height: 68px; }
  .player-face { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; background: #f5f5f5; }
    .card-title { color: var(--team-primary, #333333); }
  .team-bar { height: 4px; background: var(--team-primary, #0d6efd); }
  .team-badge { background: var(--team-primary, #0d6efd); color: var(--team-text, #fff); }
  .team-logo { width: 18px; height: 18px; object-fit: contain; vertical-align: text-bottom; }
  .team-logo-lg { width: 44px; height: 44px; object-fit: contain; }
  .opp-badge { background: #6c757d; color: #fff; }
  .state-badge { font-weight: 700; }
  .state-live { background: #dc3545; color: #fff; }
  .state-final { background: #198754; color: #fff; }
  .state-scheduled { background: #6c757d; color: #fff; }
  /* Gold homered badge */
  .homered-badge { background: #D4AF37; color: #000; font-weight: 700; }
  </style>
  <script>
    function applyFilters() {
      const params = new URLSearchParams(window.location.search);
  const dateEl = document.getElementById('date');
  const date = dateEl ? dateEl.value : '';
  const team = document.getElementById('team').value || '';
  const gameEl = document.getElementById('game');
  const game = gameEl ? gameEl.value : '';
  let limit = document.getElementById('limit').value || '50';
  const homeredOnly = document.getElementById('homeredOnly');
  const valueOnly = document.getElementById('valueOnly');
  if (date) params.set('date', date); else params.delete('date');
      if (team) params.set('team', team); else params.delete('team');
  if (game) params.set('game', game); else params.delete('game');
      // If homered-only, ensure a large limit so all candidates render
      if (homeredOnly && homeredOnly.checked) {
        const limNum = parseInt(limit, 10);
        if (!Number.isFinite(limNum) || limNum < 300) {
          limit = '500';
          const limInput = document.getElementById('limit');
          if (limInput) limInput.value = limit;
        }
      }
      params.set('limit', limit);
  if (homeredOnly && homeredOnly.checked) params.set('homered','1'); else params.delete('homered');
  if (valueOnly && valueOnly.checked) params.set('value','1'); else params.delete('value');
  // Be explicit about leading '?'
  window.location.search = '?' + params.toString();
    }

    async function openPlayerModal(name, team) {
      const params = new URLSearchParams(window.location.search);
      const date = params.get('date') || '';
      const qs = new URLSearchParams({ name, team });
      if (date) qs.set('date', date);
      const res = await fetch(`/api/player-detail?${qs.toString()}`);
      if (!res.ok) return;
      const d = await res.json();
  const modalTitle = document.getElementById('playerModalLabel');
  modalTitle.textContent = `${d.name} (${d.team}) — Score ${d.hr_score}`;
  document.getElementById('playerModalImg').src = d.image_url;
  document.getElementById('playerModalName').textContent = d.name;
  document.getElementById('playerModalOpp').textContent = `vs ${d.opposing_pitcher || 'TBD'}`;
  document.getElementById('playerModalStats').textContent = `Season: HR ${d.stats?.homeRuns ?? '-'} | AVG ${d.stats?.battingAvg ?? '-'} | SLG ${d.stats?.slugging ?? '-'}`;
  // Team branding on modal header
  const headerEl = document.getElementById('playerModalHeader');
  headerEl.style.background = d.team_primary || '#0d6efd';
  headerEl.style.color = d.team_text || '#ffffff';
  const logoEl = document.getElementById('playerModalTeamLogo');
  logoEl.src = d.team_logo || '';
  logoEl.style.display = d.team_logo ? 'block' : 'none';
      const f = d.factors || {};
      document.getElementById('playerModalFactors').innerHTML = `
        <div class="row g-2">
          <div class="col-6 col-md-4"><span class="badge bg-secondary">Power</span> ${f.power_comp ?? '-'} </div>
          <div class="col-6 col-md-4"><span class="badge bg-secondary">Recent</span> ${f.recent_comp ?? '-'} </div>
          <div class="col-6 col-md-4"><span class="badge bg-secondary">Pitcher</span> ${f.pitcher_comp ?? '-'} </div>
          <div class="col-6 col-md-4"><span class="badge bg-secondary">Park/Weather</span> ${f.park_weather_pct ?? '-'}% </div>
          <div class="col-6 col-md-4"><span class="badge bg-secondary">Pitch-type</span> ${f.pitchtype_bonus ?? '-'} </div>
          <div class="col-6 col-md-4"><span class="badge bg-secondary">Market</span> ${f.market_scaler_pct ?? '-'}% </div>
          <div class="col-6 col-md-4"><span class="badge bg-secondary">PA%</span> ${f.pa_multiplier_pct ?? '-'}% </div>
        </div>`;
      const w = d.weather || {}; const p = d.park || {}; const h = d.h2h || {};
      // Odds
      const o = d.odds || {};
      const best = o.best;
      const offers = Array.isArray(o.offers) ? o.offers : [];
      if (best && (best.best_prob || best.best_american)) {
        const probPct = best.best_prob ? (best.best_prob * 100).toFixed(1) + '%' : '-';
    let amer = (best.best_american!==undefined && best.best_american!==null) ? best.best_american : '-';
    if (typeof amer === 'number' && amer >= 0) amer = `+${amer}`;
    let html = `<div><span class="badge bg-dark">Anytime HR Odds</span> ${amer} (${probPct})` + (best.source ? ` — <span class="text-muted small">${best.source}</span>` : '') + `</div>`;
        if (offers.length > 0) {
          html += '<div class="small mt-1">' + offers.slice(0,6).map(off => {
            const pp = (off.prob!==undefined && off.prob!==null) ? (off.prob*100).toFixed(1)+'%' : '-';
            const a = (off.american!==undefined && off.american!==null) ? off.american : '-';
            const b = off.book || 'Book';
            return `<span class=\"badge text-bg-light me-1 mb-1\">${b}: ${pp} (${a})</span>`;
          }).join('') + '</div>';
        }
        document.getElementById('playerModalOdds').innerHTML = html;
        try {
          const val = (d.odds && d.odds.value) || {};
          const container = document.getElementById('playerModalOdds');
          if (container && (val.value_pp !== undefined || val.fair_american !== undefined)) {
            const fair = (typeof val.fair_american === 'number') ? (val.fair_american >= 0 ? `+${val.fair_american}` : `${val.fair_american}`) : '-';
            const vpp = (typeof val.value_pp === 'number') ? `${val.value_pp.toFixed(1)}pp` : '-';
            const div = document.createElement('div');
            div.className = 'small text-muted';
            div.innerHTML = `<span class=\"badge text-bg-success me-1\">Value</span> Model−Market: ${vpp} · Fair: ${fair}`;
            container.appendChild(div);
          }
        } catch {}
      } else {
        document.getElementById('playerModalOdds').innerHTML = '';
      }
      document.getElementById('playerModalWeather').textContent = `Weather: ${w.temperature ?? '-'}°F, wind ${w.wind_speed ?? '-'} mph ${w.wind_direction ?? ''}${w.roof ? `, roof ${w.roof}`:''}`;
      document.getElementById('playerModalPark').textContent = `Park: ${p.venue_name ?? '-'} | HR factor ${p.hr_factor ?? '-'}`;
  const pitcherLabel = d.opposing_pitcher ? `Vs ${d.opposing_pitcher}` : 'Vs Pitcher';
  document.getElementById('playerModalH2H').textContent = (h && (h.pa || h.ab)) ? `${pitcherLabel}: PA ${h.pa ?? h.ab}, HR ${h.hr ?? 0}, AVG ${h.avg ?? '-'}, SLG ${h.slg ?? '-'}` : 'No hitter vs pitcher data';
  const modalEl = document.getElementById('playerModal');
  const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }
  </script>
  </head>
<body class="bg-light">
  <div class="container py-3">
    <div class="d-flex flex-wrap align-items-baseline gap-2 mb-2">
      <h2 class="m-0">HR Scores</h2>
      <span class="text-muted small">Date: {{ date }} | Generated: {{ generated_at }}</span>
    </div>

    <!-- Scoring explainer (collapsible) -->
    <div class="mb-3">
      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#scoringHelp" aria-expanded="false" aria-controls="scoringHelp">
        Scoring explainer
      </button>
      <div class="collapse mt-2" id="scoringHelp">
        <div class="card">
          <div class="card-body">
            <h6 class="mb-2">How the HR Score is computed</h6>
            <ul class="mb-2 small">
              <li><strong>Power (52%)</strong>: season HRs, ISO, SLG, Statcast exit velocity and barrel rate (normalized).</li>
              <li><strong>Recent (12%)</strong>: last-14-day HR rate.</li>
              <li><strong>Pitcher (26%)</strong>: opponent ERA and HR allowed with handedness splits; bullpen blending when available.</li>
              <li><strong>Park/Weather (7%)</strong>: ballpark HR factor and weather (wind, temperature, roof; domes minimize weather).</li>
              <li><strong>H2H bonus</strong>: small bump for strong historical SLG/HR vs the opposing pitcher.</li>
              <li><strong>Pitch-type bonus</strong>: alignment of batter xSLG-by-pitch vs pitcher’s top pitches and usage.</li>
              <li><strong>Market scaler</strong>: team implied runs scale the score slightly.</li>
              <li><strong>PA multiplier</strong>: lineup slot adjusts for expected plate appearances.</li>
            </ul>
            <p class="mb-0 small text-muted">Final scores are scaled and capped 0–100 using the selected date’s dataset.</p>
          </div>
        </div>
      </div>
    </div>

    {% if not players or players|length == 0 %}
      <p class="text-muted">No players found. Ensure hr-scores-YYYY-MM-DD.json exists in /data. Try running generate_hr_scores.py.</p>
    {% else %}

    {% if topk_summary and topk_summary|length > 0 %}
    <div class="row g-2 mb-3">
      {% for s in topk_summary %}
      <div class="col-12 col-md-4">
        <div class="card">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">Top {{ s.k }} Hit Rate</div>
              <div class="text-muted small">Hits: {{ s.hits }} / {{ s.k }}</div>
            </div>
            <span class="badge bg-primary fs-6">{{ (s.rate*100)|round(1) }}%</span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="row g-2 align-items-end mb-3">
      <div class="col-auto">
        <label class="form-label m-0">Date</label>
        <input id="date" type="date" class="form-control form-control-sm" value="{{ date }}" onchange="applyFilters()" />
      </div>
      <div class="col-auto">
        <label class="form-label m-0">Team</label>
        <select id="team" class="form-select form-select-sm" onchange="applyFilters()">
          <option value="">All</option>
          {% for code in team_codes %}
            <option value="{{ code }}" {% if team == code %}selected{% endif %}>{{ code }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label m-0">Game</label>
        <select id="game" class="form-select form-select-sm" onchange="applyFilters()">
          <option value="">All</option>
          {% for g in games %}
            <option value="{{ g.value }}" {% if game == g.value %}selected{% endif %}>{{ g.label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label m-0">Limit</label>
  <input id="limit" type="number" min="8" max="200" value="{{ limit or 50 }}" class="form-control form-control-sm" onchange="applyFilters()" />
      </div>
      <div class="col-auto form-check ms-2">
        <input class="form-check-input" type="checkbox" value="1" id="homeredOnly">
        <label class="form-check-label" for="homeredOnly">
          Homered only
        </label>
      </div>
      <div class="col-auto form-check ms-2">
        <input class="form-check-input" type="checkbox" value="1" id="valueOnly">
        <label class="form-check-label" for="valueOnly">
          Value only
        </label>
      </div>
  <div class="col-auto"><span id="showingCount" class="text-muted small" data-total="{{ total }}">Showing {{ shown }} of {{ total }}</span></div>
    </div>

    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3">
      {% for p in players %}
  <div class="col">
  <div class="card player-card" data-team="{{ p.team }}" data-primary="{{ p.team_primary }}" data-text="{{ p.team_text }}" data-mlbam-id="{{ p.mlbam_id or '' }}" data-player-name="{{ p.name }}" data-value="{% if p.value_pp is defined and p.value_pp >= 35 %}1{% else %}0{% endif %}" role="button" tabindex="0" aria-label="Open details for {{ p.name }}"
       onclick="openPlayerModal('{{ p.name|e }}','{{ p.team|e }}')"
       onkeypress="if(event.key==='Enter'||event.key===' '){ openPlayerModal('{{ p.name|e }}','{{ p.team|e }}'); }">
          <div class="team-bar"></div>
          <div class="px-2 pt-2 d-flex justify-content-between align-items-center media-row">
            <img src="{{ p.image_url }}" class="player-face" alt="{{ p.name }} headshot" loading="lazy" width="64" height="64">
            <img src="{{ p.team_logo }}" class="team-logo-lg" alt="{{ p.team }} logo" width="44" height="44"
                 data-alt-logo="{% if p.team_id %}https://www.mlbstatic.com/team-logos/{{ p.team_id }}.svg{% endif %}"
                 onerror="if(this.dataset.altLogo && this.src!==this.dataset.altLogo){ this.src=this.dataset.altLogo; } else { this.style.display='none'; }" />
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="card-title mb-1">{{ p.name }}</h6>
                <div class="text-muted small">
                  <span class="badge team-badge me-1">{{ p.team }}</span>
                  vs {% if p.opponent_team %}<span class="badge opp-badge" data-opp="{{ p.opponent_team }}">{{ p.opponent_team }}</span>{% else %}TBD{% endif %}
                </div>
              </div>
              <div class="d-flex flex-column align-items-end">
                <span class="badge score-pill">{{ p.hr_score }}</span>
                {% if p.value_pp is defined and p.value_pp >= 35 %}
                  <span class="badge rounded-pill bg-success mt-1">Value</span>
                {% endif %}
              </div>
            </div>
      <div class="mt-2 text-muted small">
              <div>Season HRs: {{ p.stats.homeRuns }}</div>
              {% if p.odds_prob %}
                <div class="mt-1">
                  <span class="badge rounded-pill bg-dark" title="Anytime HR ({{ p.odds_source or 'Odds' }})">{% set amer = p.odds_american %}{% if amer is not none %}{% if amer >= 0 %}+{{ amer }}{% else %}{{ amer }}{% endif %}{% else %}-{% endif %} ({{ (p.odds_prob*100)|round(1) }}%)</span>
                </div>
              {% endif %}
            </div>
            {% if is_today and p.game_state %}
              {% set st = p.game_state %}
              <div class="mt-1">
                <span class="badge state-badge {% if st=='LIVE' %}state-live{% elif st=='FINAL' %}state-final{% else %}state-scheduled{% endif %} game-state-badge" data-team="{{ p.team }}">
                  {% if st=='LIVE' %}Live{% elif st=='FINAL' %}Final{% else %}Scheduled{% endif %}
                </span>
              </div>
            {% endif %}
            <div class="mt-1">
              {% if p.homered %}
                <span class="badge homered-badge" title="Homered on {{ date }}">Homered{% if p.hr_count_on_date and p.hr_count_on_date > 1 %} ×{{ p.hr_count_on_date }}{% endif %}</span>
              {% else %}
                <span class="badge homered-badge d-none" title="Homered on {{ date }}">Homered</span>
              {% endif %}
            </div>
          </div>
          <div class="card-footer bg-white">
            <div class="row text-center small g-0">
              <div class="col"><div>Pow</div><strong>{{ p.factors.power_comp }}</strong></div>
              <div class="col"><div>Rec</div><strong>{{ p.factors.recent_comp }}</strong></div>
              <div class="col"><div>Pit</div><strong>{{ p.factors.pitcher_comp }}</strong></div>
              <div class="col"><div>Park</div><strong>{{ p.factors.park_weather_pct }}%</strong></div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% endif %}
  </div>

  <!-- Player Modal -->
  <div class="modal fade" id="playerModal" tabindex="-1" aria-labelledby="playerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" id="playerModalHeader">
          <div class="d-flex align-items-center gap-2">
            <img id="playerModalTeamLogo" width="28" height="28" alt="team logo" />
            <h5 class="modal-title m-0" id="playerModalLabel">Player</h5>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <img id="playerModalImg" class="img-fluid rounded" alt="player" />
              <div class="mt-2 fw-semibold" id="playerModalName"></div>
              <div class="text-muted" id="playerModalOpp"></div>
              <div class="text-muted small" id="playerModalStats"></div>
            </div>
            <div class="col-12 col-md-8">
              <div class="mb-2" id="playerModalFactors"></div>
              <div class="mb-2" id="playerModalOdds"></div>
              <div class="text-muted" id="playerModalWeather"></div>
              <div class="text-muted" id="playerModalPark"></div>
              <div class="mt-2" id="playerModalH2H"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function updateShowingCount() {
      const counter = document.getElementById('showingCount');
      if (counter) {
        const total = parseInt(counter.getAttribute('data-total')||'0');
        const visible = Array.from(document.querySelectorAll('.player-card'))
          .filter(card => {
            const col = card.closest('.col') || card.parentElement;
            return col && col.style.display !== 'none';
          }).length;
        counter.textContent = `Showing ${visible} of ${total}`;
      }
    }
    function applyHomeredFilter() {
      const cb = document.getElementById('homeredOnly');
      const enabled = !!(cb && cb.checked);
      document.querySelectorAll('.player-card').forEach(card => {
        const col = card.closest('.col') || card.parentElement;
        const badge = card.querySelector('.homered-badge');
        const isVisible = !!(badge && !badge.classList.contains('d-none'));
        if (enabled && !isVisible) {
          if (col) col.style.display = 'none';
        } else {
          if (col) col.style.display = '';
        }
      });
      updateShowingCount();
    }
    function applyValueFilter() {
      const cb = document.getElementById('valueOnly');
      const enabled = !!(cb && cb.checked);
      document.querySelectorAll('.player-card').forEach(card => {
        const col = card.closest('.col') || card.parentElement;
        const isValue = (card.getAttribute('data-value')||'0') === '1';
        if (enabled && !isValue) {
          if (col) col.style.display = 'none';
        } else {
          // Only show if not hidden by other filters
          if (col && col.style.display === 'none') {
            // leave hidden (homered filter may have applied)
          } else if (col) {
            col.style.display = '';
          }
        }
      });
      updateShowingCount();
    }
    // Client-side fallback: apply team colors even if server-side variables are missing
    const TEAM_COLORS = {
      'ARI':'#A71930','ATL':'#CE1141','BAL':'#DF4601','BOS':'#BD3039','CHC':'#0E3386','CWS':'#27251F','CIN':'#C6011F','CLE':'#E31937',
      'COL':'#333366','DET':'#0C2340','HOU':'#EB6E1F','KC':'#004687','KCR':'#004687','LAA':'#BA0021','LAD':'#005A9C','MIA':'#00A3E0','MIL':'#12284B',
      'MIN':'#002B5C','NYM':'#002D72','NYY':'#0C2340','OAK':'#003831','PHI':'#E81828','PIT':'#FDB827','SD':'#2F241D','SEA':'#0C2C56',
      'SF':'#FD5A1E','STL':'#C41E3A','TB':'#092C5C','TBR':'#092C5C','TEX':'#003278','TOR':'#134A8E','WSH':'#AB0003','WSN':'#AB0003'
    };
    function hexToRgb(h){h=(h||'').replace('#','');if(h.length===3)h=h.split('').map(c=>c+c).join('');const r=parseInt(h.substr(0,2),16)||0;const g=parseInt(h.substr(2,2),16)||0;const b=parseInt(h.substr(4,2),16)||0;return [r,g,b];}
    function textColorForBg(hex){const [r,g,b]=hexToRgb(hex);const L=(0.2126*r+0.7152*g+0.0722*b)/255;return L>0.6?'#000000':'#FFFFFF';}
    window.addEventListener('DOMContentLoaded',()=>{
      // Initialize Homered filter from URL param
      try {
        const params = new URLSearchParams(window.location.search);
        const hom = params.get('homered');
        const val = params.get('value');
        const cb = document.getElementById('homeredOnly');
        const vb = document.getElementById('valueOnly');
        if (cb) {
          cb.checked = (hom === '1' || hom === 'true');
          cb.addEventListener('change', () => {
            // Reload with homered param and bumped limit so all homers show
            applyFilters();
          });
          if (cb.checked) applyHomeredFilter();
        }
        if (vb) {
          vb.checked = (val === '1' || val === 'true');
          vb.addEventListener('change', () => {
            // Reload to persist param; client-side filter will apply on load
            applyFilters();
          });
          if (vb.checked) applyValueFilter();
        }
      } catch {}
      document.querySelectorAll('.player-card').forEach(card=>{
        const team=(card.getAttribute('data-team')||'').toUpperCase();
  const primary=card.getAttribute('data-primary')||TEAM_COLORS[team]||'#444444';
  const text=card.getAttribute('data-text')||textColorForBg(primary);
        // Apply prominent accents
        card.style.border=`2px solid ${primary}`;
        const bar=card.querySelector('.team-bar'); if(bar) bar.style.background=primary;
        const title=card.querySelector('.card-title'); if(title) title.style.color=primary;
        const score=card.querySelector('.score-pill'); if(score){ score.style.background=primary; score.style.color=text; }
        const badge=card.querySelector('.team-badge'); if(badge){ badge.style.background=primary; badge.style.color=text; }
        // Color the opponent badge
        const oppEl=card.querySelector('.opp-badge');
        if(oppEl){
          const opp=(oppEl.getAttribute('data-opp')||'').toUpperCase();
          const oppColor=TEAM_COLORS[opp]||'#6c757d';
          oppEl.style.background=oppColor;
          oppEl.style.color='#ffffff';
          oppEl.style.fontWeight='600';
        }
      });

      // Live HR polling for today's date only
      try {
        const params = new URLSearchParams(window.location.search);
        const selectedDate = params.get('date');
        // Compute today in the user's local timezone (not UTC)
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        const todayStr = `${yyyy}-${mm}-${dd}`;
        const isToday = !selectedDate || selectedDate === todayStr;
  if (isToday) {
          const updateBadges = (hitters) => {
            // hitters is an object keyed by mlbam id -> { name, hr }
            const nameMap = {};
            try {
              for (const [pid, rec] of Object.entries(hitters||{})) {
                const nm = (rec && rec.name) ? String(rec.name) : '';
                if (!nm) continue;
                const key = nm.toLowerCase();
                nameMap[key] = rec;
              }
            } catch {}
            document.querySelectorAll('.player-card').forEach(card => {
              const pid = (card.getAttribute('data-mlbam-id')||'').trim();
              if (!pid) return;
              const badge = card.querySelector('.homered-badge');
              if (!badge) return;
              const rec = hitters && hitters[pid];
              if (rec) {
                badge.classList.remove('d-none');
                const count = parseInt(rec.hr||0);
                badge.textContent = count>1 ? `Homered ×${count}` : 'Homered';
              } else {
                // Fallback: match by name if id not found (some feeds can miss id mapping)
                try {
                  const nm = (card.getAttribute('data-player-name')||'').toLowerCase();
                  const recByName = nameMap[nm];
                  if (recByName) {
                    badge.classList.remove('d-none');
                    const count = parseInt(recByName.hr||0);
                    badge.textContent = count>1 ? `Homered ×${count}` : 'Homered';
                  }
                } catch {}
                // Do not hide if server rendered true for earlier in day; leave as-is
              }
            });
            // Re-apply homered filter if enabled
            if (document.getElementById('homeredOnly')?.checked) applyHomeredFilter();
          };
          const poll = async () => {
            try {
              const useDate = selectedDate || todayStr;
              const url = `/api/live-hr-hitters?date=${useDate}`;
              const res = await fetch(url, { cache: 'no-store' });
              if (res.ok) {
                const data = await res.json();
                updateBadges(data && data.hitters);
              }
            } catch {}
          };
          // Initial and interval
          poll();
          setInterval(poll, 60000);

          // Game state poller
      const applyState = (state) => {
            const els = document.querySelectorAll('.game-state-badge');
            els.forEach(el => {
              const team = (el.getAttribute('data-team')||'').toUpperCase();
        const rec = state && state[team];
        if (!rec) return;
        const st = rec.state || rec;
              el.classList.remove('state-live','state-final','state-scheduled');
              const lbl = rec.label || (st==='LIVE' ? 'In Progress' : (st==='FINAL' ? 'Final' : 'Scheduled'));
              const score = rec.score_label ? ` — ${rec.score_label}` : '';
              if (st==='LIVE') { el.classList.add('state-live'); el.textContent = lbl + score; }
              else if (st==='FINAL') { el.classList.add('state-final'); el.textContent = lbl + score; }
              else { el.classList.add('state-scheduled'); el.textContent = lbl; }
            });
          };
          const pollStates = async () => {
            try {
              const useDate = selectedDate || todayStr;
              const res = await fetch(`/api/game-states?date=${useDate}`, { cache: 'no-store' });
              if (res.ok) { const d = await res.json(); applyState(d && d.teams); }
            } catch {}
          };
          pollStates();
          setInterval(pollStates, 60000);
        }
      } catch {}
    });
  </script>
</body>
</html>
